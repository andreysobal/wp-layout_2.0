'use strict';

/*
	Mobile navigation menu
	burger-style
*/
//for open/close mobile navigation menu
var keepBodyPosition = void 0;
var classToggle = function classToggle(event) {
    var el = event.currentTarget;
    el.classList.toggle('open');
    if (!!el.classList.contains('open')) {
        showModalWindow(true);
    } else {
        showModalWindow(false);
    }
};
document.querySelector('.icon').addEventListener('click', classToggle);
document.querySelector('.icon').addEventListener('touch', classToggle);

/*close mobile menu choosing necessary point*/

/*Switch on smooth scroll to anchor*/
var navLink = document.getElementsByClassName('nav__link');

Array.prototype.forEach.call(navLink, function (item, i, arr) {
    item.addEventListener("click", goFromMenu);
    item.addEventListener("touchstart", goFromMenu);
});

function goFromMenu(event) {
    event.preventDefault();
    var el = event.currentTarget;
    var dir = el.getAttribute('href');
    console.log(el.parentNode.parentNode);
    if (el.parentNode.parentNode.classList.contains('open')) {
        showModalWindow(false);
        document.querySelector('.icon').classList.remove('open');
    }

    //different behavior for anchors and external urls
    if (!!dir && dir.search('#') == 0) {
        var id = dir,
            top = $(id).offset().top;

        // smooth scroll to the anchor id
        setTimeout(function () {
            $('html, body').animate({
                scrollTop: top + 10
            }, 1000);
        }, 10);
    } else {
        window.location.href = dir;
    }
}

//open modal window end prevent page scroll under it
function showModalWindow(bool) {
    var modalEl = document.querySelector('.nav__wrapper');
    if (!!bool) {
        modalEl.className = 'nav__wrapper open';
        keepBodyPosition = window.pageYOffset;
    } else {
        modalEl.className = 'nav__wrapper';
        window.scrollTo(0, keepBodyPosition);
    }
}
'use strict';

$(document).ready(function () {
    var mailReg = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    var telReg = /^\+[0-9]{3}\s*?-*?[0-9]{2}\s*?-*?[0-9]{3}\s*?-*?[0-9]{2}\s*?-*?[0-9]{2}$/;

    $(document).on('focusin', '.rep-form textarea.textarea', function () {
        $(this).removeClass('error-field');
    });

    $('.rep-form input.textarea').focusin(function () {
        $(this).removeClass('error-field');
    });

    $('.rep-form').submit(function (event) {

        var errstr = '';
        var form = event.currentTarget,
            mailField = form.querySelector('.rep-form .email'),
            nameField = form.querySelector('.rep-form .name'),
            telField = form.querySelector('.rep-form .tel'),
            msgField = form.querySelector('.rep-form #message_text'),
            textareas = [];

        if (contains(form, msgField)) {
            textareas.push(msgField);
            if (msgField.value.length < 5) {
                if (errstr.length > 0) errstr += '\n';
                errstr += 'Поле с вопросом должно содержать минимум 5 символов.';
                msgField.classList.add('error-field');
            }
        };

        if (contains(form, telField)) {
            textareas.push(telField);
            if (!telReg.test(telField.value)) {
                errstr += 'Поле "Ваш номер" должно содержать номер телефона с кодом в формате " +***-**-******* ".' + ' ';
                telField.classList.add('error-field');
            }
        };

        if (contains(form, mailField)) {
            textareas.push(mailField);
            if (!mailReg.test(mailField.value)) {
                if (errstr.length > 0) errstr += '\n';
                errstr += 'Поле "Ваш e-mail" должно содержать правильный адрес электронной почты.' + ' ';
                mailField.classList.add('error-field');
            }
        };

        if (contains(form, nameField)) {
            textareas.push(nameField);
            if (nameField.value.length < 5) {
                if (errstr.length > 0) errstr += '\n';
                errstr += 'Поле с именем должно содержать минимум 5 символов.';
                nameField.classList.add('error-field');
            }
        };

        if (errstr.length > 0) {
            textareas.forEach(function (item, i) {
                item.blur();
            });

            if (event.preventDefault) {
                event.preventDefault();
            } else {
                event.returnValue = false;
            }

            _alert(errstr);
        } else {
            form.querySelector('h2').focus(); //change focus to some element to prevent keyboard visible state.

            $('.ironCurtain').show();
            $('.progressBar').show();

            $(this).ajaxSubmit({
                forceSync: true,
                uploadProgress: function uploadProgress(event, position, total, percentComplete) {
                    //centring again after keyboard slowly goes out
                    if (percentComplete < 99) {
                        if (!!position) {
                            $('#progressStatus').html('Загружено' + ' <span id="pos">' + bytesToSize(position, 1) + '</span> ' + ' из ' + ' <span id="total">' + bytesToSize(total, 1) + '</span>');
                        } else {
                            $('#progressStatus').html('Загрузка');
                        }
                    } else {
                        setTimeout(function () {
                            $('#progressStatus').html('Почти загружено.' + '<br>' + 'Пожалуйста, подождите еще немного.');
                        }, 5000);
                    }

                    $('.progressBar .bar').css('width', Math.abs(percentComplete * 2.7) + 'px');
                },
                // dataType identifies the expected content type of the server response
                dataType: 'json',
                // success identifies the function to invoke when the server response
                // has been received
                error: function error(xhr, textStatus, errorThrown) {
                    $('.progressBar #pos').html('');
                    $('.progressBar #total').html('');
                    $('.progressBar .bar').css('width', '10px');
                    $('.ironCurtain').hide();
                    $('.progressBar').hide();
                    _alert('Проблемы при передаче сообщения. Попробуйте еще раз.');
                    console.log(textStatus);
                    console.log(xhr.responseText);
                    console.log(errorThrown);
                },
                success: function success(data) {

                    $('#progressStatus').html('100%');
                    $('.progressBar .bar').css('width', '100%');

                    setTimeout(function () {
                        $('.ironCurtain').hide();
                        $('.progressBar').hide();

                        var mess_obj = data;
                        if (mess_obj.sent != 1 || data == '') {
                            _alert('Пожалуйста, заполните все поля формы.');
                        } else {
                            _alert('Сообщение отправлено.');
                            if (!!telField) telField.value = '';
                            if (!!mailField) mailField.value = '';
                            if (!!msgField) msgField.value = '';
                            if (!!nameField) nameField.value = '';
                        }
                    }, 500);
                }
            });
            return false;
        }
    });
});

function _alert(message) {
    setTimeout(function () {
        alert(message);
    }, 500);
}

function contains(parent, child) {
    var children = parent.childNodes;
    for (var i = children.length - 1; i >= 0; i--) {
        if (child == children[i]) return true;
    }
    return false;
}
$(function () {
    $.urlParam = function (name) {
        name = name.replace(/[\[]/, '\\\[').replace(/[\]]/, '\\\]');
        var regexS = '[\\?&]' + name + '=([^&#]*)';
        var regex = new RegExp(regexS);
        var results = regex.exec(window.location.search);

        var utm_referrer = function utm_referrer() {
            if (window.document.referrer != '') {
                var url = new URL(window.document.referrer).hostname;
                return url;
            } else {
                return null;
            }
        };

        if (results == null && utm_referrer() == window.location.hostname) {
            var results2 = regex.exec(document.referrer);
            if (results2 == null) {
                return null;
            } else {
                return decodeURIComponent(results2[1].replace(/\+/g, ' '));
            }
        } else if (results == null) {
            return null;
        } else {
            return decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
    };

    function utm_parameters() {
        if ($.urlParam('utm_source') != null) {
            $('form').append('<input type="text" name="utm_source" value="' + $.urlParam('utm_source') + '" style="display:none;">');
        };
        if ($.urlParam('utm_medium') != null) {
            $('form').append('<input type="text" name="utm_medium" value="' + $.urlParam('utm_medium') + '" style="display:none;">');
        };
        if ($.urlParam('utm_campaign') != null) {
            $('form').append('<input type="text" name="utm_campaign" value="' + $.urlParam('utm_campaign') + '" style="display:none;">');
        };
        if ($.urlParam('utm_term') != null) {
            $('form').append('<input type="text" name="utm_term" value="' + $.urlParam('utm_term') + '" style="display:none;">');
        };
        if ($.urlParam('utm_content') != null) {
            $('form').append('<input type="text" name="utm_content" value="' + $.urlParam('utm_content') + '" style="display:none;">');
        };
        if ($.urlParam('keyword') != null) {
            $('form').append('<input type="text" name="utm_keyword" value="' + $.urlParam('keyword') + '" style="display:none;">');
        };
        var str_perehoda = document.referrer;
        if (str_perehoda != '') {
            $('form').append('<input type="text" name="str_perehoda" value="' + str_perehoda + '" style="display:none;">');
        };
    };

    utm_parameters();
});
$(function () {
    console.log("loaded!");
    // Custom JS
});